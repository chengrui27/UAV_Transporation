基础工作流程介绍：
我在plan_env功能包中构建的节点能够构建ESDF地图，并将地图中所包含的距离和梯度写进共享内存中；
px4目录中的py文件能够根据我的配置创建acados求解器；
而px4_nmpc功能包中的节点能够读取共享内存中的信息，并将参数传递进acados求解器中，用于设置约束使无人机能够避障；

任务：

目前已经能够初步实现避障功能，但是我觉得约束的设置存在一些不合理的地方；
目前使用硬约束来实现避障功能，虽然能够避障，但是规划的轨迹仍然在障碍物的附近，很容易导致约束条件无法满足，进而造成求解失败，求解器经常出现如下提醒：
[nmpc_controller-1] SQP_RTI: QP solver returned error status 9 QP iteration 1.
帮我分析为什么会出现这个问题，并提出一套更好的改进方案；
（已完成）

软约束已经设置成功，无人机虽然不会求解失败，但依然出现贴着安全边界飞行的情况，如何解决这个问题；
（已完成）

发布新的目标点时，是否会从旧的轨迹开始推测，这会导致esdf地图的信息不准确，进而导致求解失败吗；
如果发生了这种情况，换用新的目标点似乎也没法解决；
有新的目标点时，重置标志位是否有用；
（以解决）

在设置新的目标点时重置first_solve_done_标志位；
如果这个标志位被重置，初始化acados参数，将距离设置为10,将梯度设置为0，并且初始化solver的内部状态；
(已解决)

在acados求解器中设置约束的时候，使用了一阶梯度近似，这会导致求解器只考虑了离自己最近障碍物的距离，忽视了其他的障碍物；
并且当规划出的轨迹原理参考点时，离无人机最近的障碍物切换，但是距离和地图并没有更新，导致旧的距离和梯度信息失效，这都是因为在一次solver的过程中只更新了一次地图信息；
这就会导致无人机可能为了避开右边的近距离障碍物，而撞上左边的障碍物；
分析这个问题，有合适的解决方案吗？
（已解决）

按照方案3修改，但是只修改c++部分的代码，不需要修改python中的仿真；
每进行一次内层循环，读取求解出的预测，判断是否碰撞；
不碰撞就跳出不再求解，输出控制量；若是发生碰撞，就用当前的点再次查询esdf地图，更新参数，并再次求解；
外层循环最多执行3次，这是为了保证实时性；
(暂未解决，还应该加上方案1，让求解的轨迹不要突变太大，也是为了保证无人机能跟上速度和加速度的突变，似乎只要限制mpc输入不要突变太大就好了)

更新的局部边界是多大，是固定的形状和大小，还是动态变化的；
局部范围内没扫描的地方是如何处理的，比如障碍物的后面，是当作占据还是空闲；
ESDF地图是根据什么更新的;
（已解决）

无人机离障碍物很近的时候，雷达只能扫描到障碍物的局部，扫描不到障碍物的上方或下方，导致无人机总是认为圆柱型障碍物的下半段是空的，随后规划从下部通过障碍物，导致撞到障碍；
（已解决）

如果添加之前的方案1：收紧“信任域”，避免解跑得太远；
配合现在的内环多次求解，是否能更好的应对问题；

有的时候会卡进障碍物；
ESDF是如何计算梯度的，如果位于障碍物的中间，梯度该指向哪里，如何计算出的；
(初值吃猜测很重要，不要让初始点进入障碍物中心)
（ESDF地图的效果需要测试，障碍物中心如何处理，检查梯度）

codex resume 019ac3d7-5c58-7ac0-83e1-fd1655148ca9